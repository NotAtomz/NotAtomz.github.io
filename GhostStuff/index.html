<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motion Ghost</title>

<!-- iPhone Add-to-Home-Screen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="icon.png">

<style>
body {
    background: #000;
    color: #ff0000;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
}

button {
    width: 90%;
    padding: 18px;
    margin: 12px;
    background: #200;
    color: #ff0000;
    border: 2px solid #ff0000;
    font-size: 20px;
    border-radius: 0px; /* square buttons */
}

.box {
    border: 2px solid #ff0000;
    padding: 20px;
    margin: 25px;
    width: 90%;
    font-size: 28px;
    margin-left: auto;
    margin-right: auto;
}

.indicator {
    width: 25px;
    height: 25px;
    background: gray;
    border: 2px solid #ff0000;
    margin: 20px auto;
}
</style>
</head>
<body>

<h1>Motion Ghost</h1>

<!-- Permissions -->
<div id="permissionArea">
    <p>Tap below to enable motion & touch sensors:</p>
    <button onclick="requestPermissions()">Enable Sensors</button>
</div>

<!-- Menu -->
<div id="menu" style="display:none;">
    <button onclick="startCalibration()">Calibrate</button>
</div>

<!-- Active Detector UI -->
<div id="detector" style="display:none;">
    <div class="box" id="motionBox">Motion: Stable</div>
    <div class="box" id="touchBox">Touch: None</div>

    <div class="indicator" id="alertCircle"></div>

    <button onclick="startCalibration()">Recalibrate</button>
</div>

<script>
// ---------------------------
// Audio
// ---------------------------
let audio = new Audio("Musicbox.mp3");
audio.loop = false;

audio.addEventListener("ended", () => {
    audio.currentTime = 0;
    if (alarmActive) audio.play();
});

// ---------------------------
// States
// ---------------------------
let baseline = { x:0, y:0, z:0 };
let calibrated = false;

let motionTriggered = false;
let touchTriggered = false;
let alarmActive = false;

let motionThreshold = 0.20;

// ---------------------------
// Permissions
// ---------------------------
async function requestPermissions() {
    try {
        const motion = DeviceMotionEvent.requestPermission?.();
        const orient = DeviceOrientationEvent.requestPermission?.();

        if (motion) await DeviceMotionEvent.requestPermission();
        if (orient) await DeviceOrientationEvent.requestPermission();

        document.getElementById("permissionArea").style.display = "none";
        document.getElementById("menu").style.display = "block";
    } catch (e) {
        alert("Permissions denied.");
    }
}

// ---------------------------
// Calibration
// ---------------------------
function startCalibration() {
    calibrated = false;
    motionTriggered = false;
    touchTriggered = false;
    alarmActive = false;

    document.getElementById("menu").style.display = "none";
    document.getElementById("detector").style.display = "block";

    let motionBox = document.getElementById("motionBox");
    let touchBox = document.getElementById("touchBox");
    let circle = document.getElementById("alertCircle");

    motionBox.style.background = "";
    motionBox.style.color = "#ff0000";
    motionBox.innerHTML = "Motion: Calibrating...";

    touchBox.style.background = "";
    touchBox.style.color = "#ff0000";
    touchBox.innerHTML = "Touch: Calibrating...";

    circle.style.background = "gray";

    audio.currentTime = 0;
    audio.play();

    setTimeout(() => {
        calibrated = true;
        audio.pause();
        motionBox.innerHTML = "Motion: Stable";
        touchBox.innerHTML = "Touch: None";
    }, 2000);
}

// ---------------------------
// Motion Detection
// ---------------------------
window.addEventListener("devicemotion", e => {
    if (!calibrated) {
        baseline.x = e.acceleration.x;
        baseline.y = e.acceleration.y;
        baseline.z = e.acceleration.z;
        return;
    }

    let dx = Math.abs(e.acceleration.x - baseline.x);
    let dy = Math.abs(e.acceleration.y - baseline.y);
    let dz = Math.abs(e.acceleration.z - baseline.z);

    let movement = dx + dy + dz;

    if (movement > motionThreshold) {
        motionTriggered = true;
        updateAlarmState();
    } else {
        motionTriggered = false;
        resetMotionBox();
        updateAlarmState();
    }
});

// ---------------------------
// Touch Detection
// ---------------------------
window.addEventListener("touchstart", () => {
    touchTriggered = true;
    updateAlarmState();
});

window.addEventListener("touchend", () => {
    touchTriggered = false;
    resetTouchBox();
    updateAlarmState();
});

// ---------------------------
// Update Alarm State (Main Logic Fix)
// ---------------------------
function updateAlarmState() {
    let circle = document.getElementById("alertCircle");
    let motionBox = document.getElementById("motionBox");
    let touchBox = document.getElementById("touchBox");

    // If either trigger is active → alarm on
    if (motionTriggered || touchTriggered) {
        if (!alarmActive) audio.play();
        alarmActive = true;

        circle.style.background = "white";

        if (motionTriggered) {
            motionBox.style.background = "#ff0000";
            motionBox.style.color = "#000";
            motionBox.innerHTML = "Motion: DETECTED";
        }

        if (touchTriggered) {
            touchBox.style.background = "#ff0000";
            touchBox.style.color = "#000";
            touchBox.innerHTML = "Touch: DETECTED";
        }

    } else {
        // Both stopped → alarm off
        alarmActive = false;
        audio.pause();

        circle.style.background = "gray";
    }
}

// ---------------------------
// Reset Functions
// ---------------------------
function resetMotionBox() {
    let motionBox = document.getElementById("motionBox");
    motionBox.style.background = "";
    motionBox.style.color = "#ff0000";
    motionBox.innerHTML = "Motion: Stable";
}

function resetTouchBox() {
    let touchBox = document.getElementById("touchBox");
    touchBox.style.background = "";
    touchBox.style.color = "#ff0000";
    touchBox.innerHTML = "Touch: None";
}
</script>


<!-- PWA MANIFEST INSIDE HTML -->
<script type="application/json" id="manifest">
{
  "name": "Motion Ghost",
  "short_name": "MotionGhost",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#000000",
  "theme_color": "#ff0000",
  "icons": [
    {
      "src": "icon.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
</script>

<script>
// Inject manifest dynamically (Safari-friendly)
const manifestContent = document.getElementById("manifest").textContent;
const blob = new Blob([manifestContent], {type: "application/json"});
const manifestURL = URL.createObjectURL(blob);
const link = document.createElement("link");
link.rel = "manifest";
link.href = manifestURL;
document.head.appendChild(link);
</script>

</body>
</html>
