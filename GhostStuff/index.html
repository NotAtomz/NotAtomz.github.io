<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motion Ghost</title>

<!-- iPhone Add-to-Home-Screen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="icon.png">

<style>
body {
    background: radial-gradient(circle at top, #120000, #000);
    color: #ff3b3b;
    font-family: "Arial Black", Arial, sans-serif;
    text-align: center;
    padding: 20px;
}

h1 {
    letter-spacing: 2px;
    text-shadow: 0 0 12px #ff0000;
}

button {
    width: 90%;
    padding: 18px;
    margin: 12px;
    background: #180000;
    color: #ff3b3b;
    border: 2px solid #ff3b3b;
    font-size: 20px;
}

.box {
    border: 2px solid #ff3b3b;
    padding: 20px;
    margin: 18px auto;
    width: 90%;
    font-size: 24px;
    box-shadow: 0 0 15px rgba(255,0,0,0.3);
}

.indicator {
    width: 30px;
    height: 30px;
    background: #444;
    border: 2px solid #ff3b3b;
    margin: 20px auto;
    box-shadow: 0 0 15px red;
}

.stats {
    border: 2px solid #ff3b3b;
    margin: 20px auto;
    padding: 12px;
    width: 90%;
    font-size: 16px;
}

canvas {
    width: 90%;
    height: 140px;
    border: 2px solid #ff3b3b;
    background: #050000;
    margin-top: 12px;
}
</style>
</head>

<body>

<h1>Motion Ghost</h1>

<!-- Permissions -->
<div id="permissionArea">
    <p>Tap below to enable motion & touch sensors:</p>
    <button onclick="requestPermissions()">Enable Sensors</button>
</div>

<!-- Menu -->
<div id="menu" style="display:none;">
    <button onclick="startCalibration()">Calibrate</button>
</div>

<!-- Active Detector UI -->
<div id="detector" style="display:none;">
    <div class="box" id="motionBox">Motion: Stable</div>
    <div class="box" id="touchBox">Touch: None</div>

    <div class="indicator" id="alertCircle"></div>

    <!-- Stats + Graph -->
    <div class="stats" id="statsArea">
        <div>X: <span id="sx">0</span></div>
        <div>Y: <span id="sy">0</span></div>
        <div>Z: <span id="sz">0</span></div>
        <div>Total Movement: <span id="sm">0</span></div>
        <canvas id="motionGraph"></canvas>
    </div>

    <button onclick="startCalibration()">Recalibrate</button>
</div>

<script>
// ---------------------------
// Audio
// ---------------------------
let audio = new Audio("Musicbox.mp3");
audio.loop = false;

audio.addEventListener("ended", () => {
    audio.currentTime = 0;
    if (alarmActive) audio.play();
});

// ---------------------------
// States
// ---------------------------
let baseline = { x:0, y:0, z:0 };
let calibrated = false;

let motionTriggered = false;
let touchTriggered = false;
let alarmActive = false;

let motionThreshold = 0.08;
let motionCooldownTimer = null;

// ---------------------------
// Permissions
// ---------------------------
async function requestPermissions() {
    try {
        const motion = DeviceMotionEvent.requestPermission?.();
        const orient = DeviceOrientationEvent.requestPermission?.();

        if (motion) await DeviceMotionEvent.requestPermission();
        if (orient) await DeviceOrientationEvent.requestPermission();

        document.getElementById("permissionArea").style.display = "none";
        document.getElementById("menu").style.display = "block";
    } catch {
        alert("Permissions denied.");
    }
}

// ---------------------------
// Calibration
// ---------------------------
function startCalibration() {
    calibrated = false;
    motionTriggered = false;
    touchTriggered = false;
    alarmActive = false;

    document.getElementById("menu").style.display = "none";
    document.getElementById("detector").style.display = "block";

    motionBox.innerHTML = "Motion: Calibrating...";
    touchBox.innerHTML = "Touch: Calibrating...";
    alertCircle.style.background = "gray";

    audio.currentTime = 0;
    audio.play();

    setTimeout(() => {
        calibrated = true;
        audio.pause();
        motionBox.innerHTML = "Motion: Stable";
        touchBox.innerHTML = "Touch: None";
    }, 2000);
}

// ---------------------------
// Motion Detection
// ---------------------------
const canvas = document.getElementById("motionGraph");
const ctx = canvas.getContext("2d");

let graphData = [];
const maxPoints = 80;

function drawGraph() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = "#ff0000";
    ctx.beginPath();

    graphData.forEach((v, i) => {
        let x = (i / maxPoints) * canvas.width;
        let y = canvas.height - (v * 800);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.stroke();
}

window.addEventListener("devicemotion", e => {
    if (!calibrated) {
        baseline.x = e.acceleration.x;
        baseline.y = e.acceleration.y;
        baseline.z = e.acceleration.z;
        return;
    }

    let dx = Math.abs(e.acceleration.x - baseline.x);
    let dy = Math.abs(e.acceleration.y - baseline.y);
    let dz = Math.abs(e.acceleration.z - baseline.z);

    let movement = dx + dy + dz;

    // Stats
    sx.textContent = dx.toFixed(3);
    sy.textContent = dy.toFixed(3);
    sz.textContent = dz.toFixed(3);
    sm.textContent = movement.toFixed(3);

    // Graph
    graphData.push(movement);
    if (graphData.length > maxPoints) graphData.shift();
    drawGraph();

    if (movement > motionThreshold) {
        motionTriggered = true;
        updateAlarmState();

        if (motionCooldownTimer) clearTimeout(motionCooldownTimer);
        motionCooldownTimer = setTimeout(() => {
            motionTriggered = false;
            resetMotionBox();
            updateAlarmState();
        }, 3000);
    }
});

// ---------------------------
// Touch Detection
// ---------------------------
window.addEventListener("touchstart", () => {
    touchTriggered = true;
    updateAlarmState();
});

window.addEventListener("touchend", () => {
    touchTriggered = false;
    resetTouchBox();
    updateAlarmState();
});

// ---------------------------
// Alarm Logic
// ---------------------------
function updateAlarmState() {
    if (motionTriggered || touchTriggered) {
        if (!alarmActive) audio.play();
        alarmActive = true;
        alertCircle.style.background = "white";

        if (motionTriggered) {
            motionBox.style.background = "#ff0000";
            motionBox.style.color = "#000";
            motionBox.innerHTML = "Motion: DETECTED";
        }

        if (touchTriggered) {
            touchBox.style.background = "#ff0000";
            touchBox.style.color = "#000";
            touchBox.innerHTML = "Touch: DETECTED";
        }

    } else {
        alarmActive = false;
        audio.pause();
        alertCircle.style.background = "gray";
    }
}

// ---------------------------
// Reset Helpers
// ---------------------------
function resetMotionBox() {
    motionBox.style.background = "";
    motionBox.style.color = "#ff3b3b";
    motionBox.innerHTML = "Motion: Stable";
}

function resetTouchBox() {
    touchBox.style.background = "";
    touchBox.style.color = "#ff3b3b";
    touchBox.innerHTML = "Touch: None";
}
</script>

</body>
</html>
